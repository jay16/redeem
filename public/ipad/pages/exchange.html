<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="UTF-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>太古汇 - 礼品兑换</title>
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no;">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/public-style.css">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/animate.min.css">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/side.css">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/tc.css">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/exchange.css">
<style>
.disabled {
	pointer-events: none;
	background-color: gainsboro !important;
}
.layui-layer-btn a {
	font-size: 12px;
}
</style>
</head>
<body>
<!-- 加载 -->
<div id="jiaZai">
  <img src="assets/images/loadbg.png"></div>
<!-- 内容 -->
<!-- 内容 -->
<div id="main">
  <div class="title">
    <div>
      <img src="assets/images/dhlp2.png">礼品兑换 - 选择礼品</div>
    <div>Gift Redemption - Select Gift</div></div>
  <div class="content">
    <div class="content_1">
      <div class="act">
        <p>
          <img src="assets/image/qian.png">可兑换的消费记录(限当日) / Redeemable</p></div>
    </div>
    <div class="content_2">
    </div>
  </div>
  <div class="anNiu">
    <a href="javascript:void (0)" class="sy">上一页
      <br/>Previous</a>
    <a href="javascript:void (0)" class="duiHuan">
      <img src="assets/images/duiHuan.png">兑换
      <br/>Redeem
      <span>99</span></a>
    <a href="javascript:void (0)" class="qxDuiHuan">
      <img src="assets/images/quXiao.png">取消兑换
      <br/>Undo
      <span>99</span></a>
    <a style="display:none;" href="javascript:void (0)" onclick="window.location.href='complete.html'"  class="tiaoGuo">
      <img src="assets/images/tiaoGuo.png">跳过问卷
      <br/>Skip survey
      <span>99</span></a>
    <a style="display:none;" href="javascript:void (0)" class="xy" onclick="window.location.href='signature.html'">下一页
      <br/>Next</a></div>
  <div class="gouXuan">
    <img src="assets/images/dhlp.png">已勾选的当日消费：￥
    <span id="today_amount_guo">0</span>,可兑换：</div>
  <div class="shangPing jin">

  </div>
  <div class="leiJi" style="display: none;">
    <img src="assets/images/dhlp.png">2017：累积消费 ￥ - 已兑换 ￥0 - 本次兑换 ￥
    <span id="ben_exchange"></span>= 剩余 ￥
    <span id="shen_exchange">
      <input type="hidden" value=""></span>， 暂无可累积兑换礼品</div>
  <div class="shangPing xin"></div>
</div>
<div class="dhlp">
  <div class="Inputs" style=""></div>
  <div>
    <a href="javascript:void (0)" class="gb">
      <img src="assets/images/gb.png"></a>
    <div class="dhlp_content">
      <div class="suo">
        <img src="assets/images/dhlp.png"></div>
      <div class="dhlp_info">
        <p class="title">兑换礼品/Gift Redemption</p>
        <span id="dui_name">X MolesKine 笔记本</span>
        <div>
          <p class="bz">备注1</p>
          <input type="text" name="remark" />
          <p class="bz">备注2</p>
          <input type="text" name="desc" /></div>
        <a id="queren" href="javascript:void (0)" onClick="window.TKH.genMallSupplyBill();" class="cs queren">确认兑换</a></div>
    </div>
  </div>
</div>
<input type="hidden" id="Exchange_id" value="" />
<div class="gn">
  <div class="dj">
    <div>
      <img src="assets/images/gn1.png" class="xs" alt="">
      <img src="assets/images/gn2.png" class="yc" alt=""></div>
    <div>
      <img src="assets/images/gn2.png"></div>
  </div>
  <div class="nr">
    <div>礼品兑换系统</div>
    <p class="lp">
      <a href="search.html">
        <img src="assets/images/dhlp.png">礼品兑换</a></p>
    <p class="mm">
      <img src="assets/images/bi.png" class="bi" alt="">修改密码</p>
    <p class="tuichu" onclick="window.TKH.logout();">
      <img src="assets/images/dl2.png">退出登录</p>
    <div class="renWu">
      <img src="assets/images/renWu.png">
      <p id="userGid"></p>
      <p class="time"></p>
    </div>
  </div>
</div>
<div class="xg">
  <div>
    <a href="javascript:void (0)" class="gb">
      <img src="assets/images/gb.png"></a>
    <div class="xg_content">
      <div class="suo">
        <img src="assets/images/bi.png"></div>
      <div class="xg_info">
        <p class="title">修改密码</p>
        <input type="password" id="oldPassword" placeholder="旧密码" />
        <input type="password" id="newPassword" placeholder="新密码" />
        <input type="password" id="rePassword" placeholder="再次输入新密码" />
        <a onclick='window.ServerAPI.resetPassword();' href="javascript:void(0);" class="cs mima">确认修改密码</a></div>
    </div>
  </div>
</div>
</body>
<!-- Javascripts -->
<script src="assets/javascripts/remJs.js"></script>
<script src="assets/javascripts/jquery-1.8.0.min.js"></script>
<script src="assets/javascripts/plugins/layer/layer.js"></script>
<script src="assets/javascripts/server_api.js"></script>
<script src="assets/javascripts/tkh.js"></script>
<script src="assets/javascripts/side.js"></script>
<script>
$(function() {
  // 消费记录
  var recordString = window.localStorage.getItem("records");
  if (recordString !== null && recordString.length > 0) {
    var records = JSON.parse(recordString),
    record = {},
    today_amount = 0;

    for (var i = 0, len = records.length; i < len; i++) {
      record = records[i];
      $(".content_2").append('\
        <div class="xf checked">\
          <p>消费金额 - 店铺名称 - 礼品 / Amount - Merchant - Redeemable</p>\
          <p>\
            <img src="assets/image/dui.png" class="guoxiao" alt="">\
            CNY ' + record["amount"] + '- ' + record["name"] + '\
            <input type="hidden" class="guoxiao_id xiaochu" value="' + record["gndgid"] + '">\
            <input type="hidden" class="guoxiao_gndgid xiaochu" value="' + record["gndgid"] + '">\
            <input type="hidden" class="guoxiao_amount xiaochu" value="' + record["amount"] + '">\
            <input type="hidden" class="guoxiao_store xiaochu" value="' + record["name"] + '">\
            <input type="hidden" class="guoxiao_serialnum xiaochu" value="' + record["serialnum"] + '">\
          </p>\
        </div>');
      today_amount += parseFloat(record["amount"]);
    }
    $("#today_amount_guo").html(today_amount);
  }

  // 3.2.3 查询有效的赠品促销接口
  window.TKH.queryMallGiftPromInfo();

  $('.gb').click(function() {
    $('.xg').fadeOut(200);
    $('.dhlp').fadeOut(200);
  });

  //商品选中
  $(document).on('click', '.shangPing>div',
  function() {
    console.log('2 = ' + this);
    if (!$('#Exchange_id').val()) {
      $('.shangPing>div').removeClass('xuanZhong');
      if ($(this).hasClass('xuanZhong')) $(this).removeClass('xuanZhong');
      else $(this).addClass('xuanZhong');
    } else {
      layer.msg('本次已兑换！', {
        time: 2000 //2s后自动关闭
      });
    }
  });

  $(document).on('click', '.xf', function() {
    if (!$('#Exchange_id').val() && !$(this).find('p').hasClass('shanchu')) {
      var today_amount = parseFloat($('#today_amount_guo').html());
      var jin = parseFloat($(this).find('.guoxiao_amount').val());
      if ($(this).find('.guoxiao_id').hasClass('xiaochu')) {
        $('#today_amount_guo').html(today_amount - jin);

        $(this).find('.guoxiao_id').removeClass('xiaochu');
        $(this).find('.guoxiao_amount').removeClass('xiaochu');
        $(this).find('.guoxiao_store').removeClass('xiaochu');
        $(this).find('.guoxiao').attr('src', '../assets/image/wu.png');
        $(this).addClass("checked");
      } else {
        $('#today_amount_guo').html(today_amount + jin);

        $(this).find('.guoxiao_id').addClass('xiaochu');
        $(this).find('.guoxiao_amount').addClass('xiaochu');
        $(this).find('.guoxiao_store').addClass('xiaochu');
        $(this).find('.guoxiao').attr('src', '../assets/image/dui.png');
        $(this).removeClass("checked");
      }
    } else {
      layer.msg('本次已兑换！', {
        time: 2000 //2s后自动关闭
      });
    }
  });
  //取消兑换
  $('.qxDuiHuan').on('click', function() {
    layer.msg('确定要取消兑换吗？', {
      time: 0 //不自动关闭
      ,
      btn: ['确定', '取消'],
      yes: function(index) {
        layer.close(index);
        window.location.href = 'search.html';
        var exchangeId = $('#Exchange_id').val();
      }
    });
  });
  $('.duiHuan').on('click', function() {
    if (!$('#Exchange_id').val()) {
      var gift_id = xua_id = '';
      var shene = parseFloat($('#shen_exchange').find('input').val());
      var today_amount = parseFloat($('#today_amount_guo').html());
      var xuanze_id = $('.xf').find('.guoxiao_id.xiaochu');
      var xuanze_id_length = $('.xf').find('.guoxiao_id.xiaochu').length;
      var ob_jin = $('.shangPing>div.xuanZhong');
      var length = $('.shangPing>div.xuanZhong').length;
      var type = 0;
      if (!$('.shangPing>div.xuanZhong').hasClass('xuzh_jin')) type = 1;
      if (((today_amount == 0 && type == 0) || (shene == 0 && type == 1)) && length != 0) {
        layer.msg('没有勾选的或累积的消费金额进行兑换！', {
          time: 2000 //2s后自动关闭
        });
        return false;
      }
      if (length == 0) {
        layer.msg('请选择礼品进行兑换！', {
          time: 2000 //2s后自动关闭
        });
        return false;
      }
      for (i = 0; i < xuanze_id_length; i++) {
        xua_id += ';' + xuanze_id[i].value + '';
      }
      gift_id = ob_jin.find('input').val();

      var giftname = ob_jin.find(".gift_name").html();
      var xuan_ids = xua_id.substr(1).split(';');
      $('.dhlp').find('.Inputs').empty();
      var html = "\
        <input type='hidden' name='balance' value='" + shene + "'/>\
        <input type='hidden' name='consuming_gou' value='" + today_amount + "'/>\
        <input type='hidden' name='gift_name' value='" + giftname + "'/>\
        <input type='hidden' name='gift_id' value='" + gift_id + "'/>\
        <input type='hidden' name='type' value='" + type + "'/>\
        <input type='hidden' name='xuan_ids' value='" + xuan_ids + "'/>";

      $('.dhlp').css('display', 'block');
      $('.dhlp').find('#dui_name').html(giftname);
      $('.dhlp').find('.Inputs').append(html);
      $('.dhlp').find('input[name="remark"]').val('');
      $('.dhlp').find('input[name="desc"]').val('');
    } else {
      layer.msg('本次已兑换！', {
        time: 2000 //2s后自动关闭
      });
    }
  });

  // //下一页
  // $('.xy').click(function() {
  //   if ($('#Exchange_id').val()) window.location.href = '../home/questniare?exchange=' + $('#Exchange_id').val();
  //   else {
  //     layer.msg('本次还未进行兑换！', {
  //       time: 2000 //2s后自动关闭
  //     });
  //   }
  // });

  //跳过问卷，到签名页
  $('.tiaoGuo').click(function() {
    if ($('#Exchange_id').val()) window.location.href = '../home/autograph?type=exchange&exchange=' + $('#Exchange_id').val();
    else {
      layer.msg('本次还未进行兑换！', {
        time: 2000 //2s后自动关闭
      });
    }
  });
  //上一页
  $('.sy').click(function() {
    if (!$('#Exchange_id').val()) {
      window.location.href = 'entry.html';
    } else {
      layer.msg('还有兑换信息没有签名！确定要退出兑换返回上一页吗？', {
        time: 0 //不自动关闭
        ,
        btn: ['确定', '取消'],
        yes: function(index) {
          layer.close(index);
          window.location.href = 'entry.html';
        }
      });
    }
  });
})

function querenAuto() {
  //询问框
  layer.msg('今天还有兑换信息没有签名！', {
    time: 2000 //2s后自动关闭
  });
  //        layer.confirm('上次兑换的还未签名！是取消该兑换信息还是签名确认兑换？', {
  //            btn: ['取消兑换','去签名'] //按钮
  //        }, function(){
  //            $('.qxDuiHuan').click();
  //        }, function(){
  //            $('.tiaoGuo').click();
  //        });
}
</script>
</html>
