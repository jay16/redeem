<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta http-equiv="refresh" content="3540"> <!-- refresh page every 59 minutes -->
<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="renderer" content="webkit">
<title>消费积分 - 礼品兑换</title>
<link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/public-style.css?timestamp=1517404944">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/animate.min.css?timestamp=1517404944">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/side.css?timestamp=1517404944">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/tc.css?timestamp=1517404944">
<link media="all" type="text/css" rel="stylesheet" href="assets/stylesheets/score-input.css?timestamp=1517404944">
<script src="assets/javascripts/remJs.js?timestamp=1517404944"></script>
<script src="assets/javascripts/jquery-1.12.4.js?timestamp=1517404944"></script>
<script src="assets/javascripts/plugins/layer/layer.js?timestamp=1517404944"></script>
<script src="assets/javascripts/server_api.js?timestamp=1517404944"></script>
<script src="assets/javascripts/tkh.js?timestamp=15024698434"></script>
</head>
<body>
<div id="jiaZai">
  <img src="assets/images/loadbg.png?timestamp=1517404944">
</div>

<script src="assets/javascripts/jquery.jedate.js?timestamp=1517404944"></script>
<link type="text/css" rel="stylesheet" href="assets/stylesheets/jquery.jedate.css?timestamp=1517404944">
<div id="main">
  <div class="title">
    <div>
      <img src="assets/images/dhlp2.png?timestamp=1517404944">消费积分 -
      <img src="assets/images/qian.png?timestamp=1517404944">消费录入
    </div>
    <div>Purchase Points - Purchase Entry</div>
  </div>
  <div class="content">
    <div class="content_1">
      <div class="act">
        <p>
          <img src="assets/images/qian.png?timestamp=1517404944">
          积分录入 / Score Input
        </p>
      </div>
    </div>
    <div class="content_2">
      <a href="javascript:void(0);" class="xinZeng" onClick="window.TKH.addRecordInput();checktip();">增加记录 / Add record</a>
    </div>
    <!-- 拍照上传页面 start -->
    <div class="picbox">
      <div class="largebox" style="display:none">
        <img src="assets/images/bg-blur.jpg" id="largePic">
        <span class="imgclose" ></span>
      </div>
      <h2>拍照/上传</h2>
      <span  style="display:none;"><input type="file" id="files" onchange="window.TKH.uploadFile(this)" accept="image/*"/></span>
      <div class="boarditem_c  piclist" id="piclist">
        <div class="boarditem_c_i boarditem_c_add">
          <a id="uploadPic" class="uploadPic" onclick="window.TKH.uploadImg(this)" href="javascript:void(0)"></a>
        </div>
      </div>
    </div>
    <!-- 拍照上传页面 end -->
  </div>
  <div class="anNiu">
    <a href="javascript:void(0);" class="sy" onclick='window.TKH.redirect_to_with_telphone("search.html");'>上一页<br/>Previous</a>
    <a href="javascript:void(0);" class="xy submit-btn">提交<br/>Submit</a>
    <a style="display: none;" href="javascript:void(0);" class="xy skip-btn">提交<br/>Submit</a>
    <button class="xy" id='nextPage' style="display:none;" onclick='window.TKH.redirect_to_with_timestamp("score-complete.html");'>下一步<br/>Next</button>
  </div>
</div>
<div class="xuanZe">
  <div>
    <a href="javascript:void(0);" class="xuanZe_gb" onclick="window.TKH.hideDQM();">
      <img src="assets/images/gb.png?timestamp=1517404944">
    </a>
    <p>
      <img src="assets/images/xuanZe.png?timestamp=1517404944">
      请选择商户 / Find merchant
    </p>
    <p>
      <input type="search" class='search-store'  placeholder="商户 / merchant" />
    </p>
    <div class="hangHu"></div>
  </div>
</div>
<div class="gn">
  <div class="dj">
    <div>
      <img src="assets/images/gn1.png?timestamp=1517404944" class="xs" alt="">
      <img src="assets/images/gn2.png?timestamp=1517404944" class="yc" alt="">
    </div>

    <div style="display:none;">
      <img src="assets/images/gn2.png?timestamp=1517404944">
    </div>
  </div>
  <div class="nr">
    <div>礼品兑换系统</div>
    <p class="lp">
      <a href="search.html">
        <img src="assets/images/dhlp.png?timestamp=1517404944">礼品兑换</a></p>
    <p class="mm">
      <img src="assets/images/bi.png?timestamp=1517404944" class="bi" alt="">修改密码</p>
    <p class="tuichu" onclick="window.TKH.logout();">
      <img src="assets/images/dl2.png?timestamp=1517404944">退出登录</p>
    <div class="renWu">
      <img src="assets/images/renWu.png?timestamp=1517404944">
      <p id="userGid"></p>
      <p class="time"></p>
    </div>
  </div>
</div>
<div class="xg">
  <div>
    <a href="javascript:void(0);" class="gb">
      <img src="assets/images/gb.png?timestamp=1517404944"></a>
    <div class="xg_content">
      <div class="suo">
        <img src="assets/images/bi.png?timestamp=1517404944"></div>
      <div class="xg_info">
        <p class="title">修改密码</p>
        <input type="password" id="oldPassword" placeholder="旧密码" />
        <input type="password" id="newPassword" placeholder="新密码" />
        <input type="password" id="rePassword" placeholder="再次输入新密码" />
        <a onclick='window.ServerAPI.resetPassword();' href="javascript:void(0);" class="cs mima">确认修改密码</a></div>
    </div>
  </div>
</div>

<style>
.tishibuton .cs { margin: 0.5rem !important; }
.tishibuton .button { margin: 0.5rem !important; }
</style>
<div class="tishibuton-area" style="display:none;" id="tishiarea1">
  <div style="min-height:120px; text-align:center; font-size:16px; line-height:30px; background: #333; color:lightgray;padding-top:20px;">
    <p class="">是否确认提交此次录入信息</p>
    <div style="margin: 0 auto;margin-top:20px;">
      <a style="margin-right:20px"  href="javascript:void(0);" onclick='window.TKH.backToUpdateScoreInput("消费积分");' class="button">否（返回修改）</a>
      <a style="margin-right:20px"  href="javascript:void(0);" onclick='window.TKH.redirect_to_with_timestamp("entry.html?from=score-input.html");' class="button">（是）消费兑换</a>
      <a href="javascript:void(0);" onclick="window.TKH.skipStoreToScoreComplete();" class="button score-input" style='margin-right:20px'>返回首页</a>
    </div>
  </div>
</div>
<div class="tishibuton-area" style="display:none;"  id="tishiarea2">
  <div style="min-height:120px; text-align:center; font-size:16px; line-height:30px; background: #333; color:lightgray;padding-top:20px;">
    <div style="margin: 0 auto;margin-top:20px;">
      <a style="margin-right:20px"  href="javascript:void(0);" onclick='window.TKH.redirect_to_with_timestamp("entry.html?from=score-input.html");' class="button">消费兑换</a>
      <a href="javascript:void(0);" onclick="window.TKH.skipStoreToScoreComplete();" class="button score-input" style='margin-right:20px'>返回首页</a>
    </div>
  </div>
</div>

<script>
// 初始一个，消费记录输入框
window.TKH.addRecordInput();

// 恢复缓存的图片
try {
  var cachedImage = JSON.parse(window.localStorage.getItem("storageImg")),
      imgIdList = cachedImage.imgid || [],
      imgUrlList = cachedImage.imgurl || [],
      nowDate,
      str,
      imgId,
      imgUrl;

  var scoreInputRecords = window.localStorage.getItem('scoreInputRecords');
  var scoreJSON = [];
  if(scoreInputRecords) {
    scoreJSON = JSON.parse(scoreInputRecords);
  }
  for (var key in scoreJSON) {
      if(key!=0) {window.TKH.addRecordInput();}
      var item = scoreJSON[key];
      $(".dq-wrapper").eq(key).find("input.store-name").val(item["store_name"]);
      $(".dq-wrapper").eq(key).find("input.serial-num").val(item["serial_num"]);
      $(".dq-wrapper").eq(key).find("input.amount").val(item["real_amt"]);
      $(".dq-wrapper").eq(key).find("input.gndcode").val(item["store_code"]);
      $(".dq-wrapper").eq(key).find("input.gndgid").val(item["gndgid"]);
      $(".dq-wrapper").eq(key).find("input.datetime").val(item["datetime"]);
  }
  // 若数组长度不同，则说明数据存储异常，放弃恢复缓存图片
  if(imgIdList.length !== imgUrlList.length) {
    imgIdList = imgUrlList = [];
    window.localStorage.removeItem('storageImg');
  }
  for(var i = 0, len = imgIdList.length; i < len; i ++) {
    if(imgIdList.length > i) {imgId = imgIdList[i];}
    if(imgUrlList.length > i) {imgUrl = imgUrlList[i];}
    nowDate = (new Date()).getTime();
    str = "<div class='boarditem_c_i imgitem' id='picbox" + nowDate + "'> \
             <img id='img" + nowDate + "' src='" + picServer + '/images/tkh/' + imgUrl + "' onclick='window.TKH.showLarge()' code='" + imgUrl + "'/> \
             <span class='absolute ico loadingico' id='loading" + nowDate + "' style='top:40%;text-align:center;left:0;right:0;'></span> \
          </div>";
    $("#piclist").prepend($(str));
    str = "<span class='closeico' onclick='window.TKH.delPic($(this))' data='" + imgId + "' attachId='" + imgId + "'></span>";
    $("#picbox" + nowDate).prepend(str);
    $("#piclist").append('<input type="hidden" class="input_imgid" value="' + imgId + '" attachId="' + imgId + '">');
    $("#piclist").append('<input type="hidden" class="input_imgurl" value="' + imgUrl + '" attachId="' + imgId + '">');
  }
} catch(e) {
  console.log(e);
}

function checktip(){
    /*===1017重复积分判断 start===*/
    $(".dq-wrapper").on("change",".store-name,.serial-num,.datetime",function(){
        var store_name='',serial_num='',gndcode='',datetime, data = null,datas = [],wrapper_class;
        var obj=$(this).parents(".dq-wrapper");
        wrapper_class=obj.attr("class").replace("dq-wrapper ", "");
        store_name = obj.find("input.store-name").val();
        serial_num = obj.find("input.serial-num").val();
        gndcode = obj.find("input.gndcode").val();
        datetime =obj.find("input.datetime").val();
        if(store_name!="" && serial_num!="" && gndcode!="" && datetime!="")
        {
            data = {
                serial_num: serial_num,
                store_name: store_name,
                store_code: gndcode,
                datetime: datetime,
                wrapper_class: wrapper_class
            };
            /*===updatecynthia0926 start===*/
            datas.push(data);
            window.TKH.isrepeatscore(datas);
        }
    })
    /*===重复积分判断 end===*/
    $(".dq-wrapper").on("click",".jian",function() {
        var idx=$(this).parents(".dq-wrapper").data("layerindex");
        var idx2=$(this).parents(".dq-wrapper").find(".dq-control").eq(0).data("layerindex");
        layer.close(idx);
        layer.close(idx2);
    })
   /* $(".dq-wrapper").on("change","input",function(){
        var idx=$(this).parents(".dq-wrapper").index();
        $(".layui-layer-tips").eq(idx-1).remove();
    })
    $(".dq-wrapper").on("click",".store-name",function(){
        var idx=$(this).parents(".dq-wrapper").index();
        $(".layui-layer-tips").eq(idx-1).remove();
    })*/
}
$(function() {
  checktip();
  // 搜索
  function display_searched_store(keywords) {
    var store_name = "",
        matched = false;
    $(".hangHu .soudingname").each(function() {
      store_name = $(this).data("name").toLowerCase();
      matched = false;
      for(var i = 0, len = keywords.length; i < len; i ++) {
        if(store_name.indexOf(keywords[i]) >= 0) {  matched = true; }
      }

      $(this).css("display", (matched ? "inline-block" : "none"));
    });
  }
  $(".search-store").bind("keyup", function() {
    var keyword = $.trim($(this).val()),
        keywords = [];
    if(!keyword.length) {
      $(".hangHu .soudingname").css("display", "inline-block");
      return false;
    }
    keywords = keyword.toLowerCase().split(/\s+/);
    console.log(keywords);
    display_searched_store(keywords);
  });

  //下一页
  $('.submit-btn').on('click', function() {
    if(!$("input.store-name").length) {
      layer.msg('你今日还没有消费记录，请填写消费记录！', {time: 2000});
      is_error = 1;
      return false;
    }
    var reg = /^([1-9][\d]{0,7}|0)(\.[\d]{1,2})?$/,
        store_code = '',
        amount,
        score,
        serial_num = '',
        serial_nums = [],
        store_and_datetime = '',
        store_and_datetimes = [],
        datetime = '',
        is_error = 0,
        all_is_ok = 1,
        store_name = '',
        amount = '',
        gndgid = '',
        gndcode = '',
        record = {},
        records = [],
        data = null,
        datas = [],
        card_number = window.localStorage.getItem('sFCARDNUM'),
        wrapper_class,
        serial_num_with_store_code,
        layer_index;

    var is_all_ok = true;
    // 已提交成功的消费项
    $(".dq-wrapper").each(function() {
      if($(this).data("submited") === "yes") {
        name = $(this).find("input.store-name").val();
        serialnum = $(this).find("input.serial-num").val();
        amount = $(this).find("input.amount").val();
        gndgid = $(this).find("input.gndgid").val();
        gndcode = $(this).find("input.gndcode").val();
        datetime = $(this).find("input.datetime").val();

        serial_num_with_store_code = gndcode + serialnum;
        serial_nums.push(serial_num_with_store_code);
        store_and_datetime = gndgid + datetime;
        store_and_datetimes.push(store_and_datetime);
      } else {
        is_all_ok = false;
      }
    });

    // 全部积分提交成功，则跳转页面
    if(is_all_ok) {
    //window.TKH.refreshRedeemScoreInput(true);
        layer.open({
            type:1,
            title: "信息",
            area:"500px",
            content:$('#tishiarea2')
        });
      return false;
    }
    // document.getElementById("files").files.length==0 || 
    if($(".input_imgid").size()==0)
    {
        layer.tips('请上传图片', $('.picbox'), { tips: [1, '#faab20'] });
        is_error = 1;
        all_is_ok = 0;
        return false;
    }
    $(".dq-wrapper").each(function() {
      if($(this).data("submited") === "no") {
        store_name = $(this).find("input.store-name").val();
        serial_num = $(this).find("input.serial-num").val();
        amount = $(this).find("input.amount").val();
        gndgid = $(this).find("input.gndgid").val();
        gndcode = $(this).find("input.gndcode").val();
        datetime = $(this).find("input.datetime").val();
        store_and_datetime = gndgid + datetime;
        wrapper_class = $(this).attr("class").replace("dq-wrapper ", "");
        is_error = 0;

        if(!store_name.length) {
          layer.tips('店铺名称不能为空', $(this).find('.store-name'), { tips: [3, '#faab20'] });
          is_error = 1;
          all_is_ok = 0;
          return false;
        }

        if(!serial_num.length) {
          layer.tips('流水号不能为空', $(this).find('.serial-num'), { tips: [3, '#faab20'] });
          is_error = 1;
          all_is_ok = 0;
          return false;
        }

        if(serial_num.length > 30) {
          layer.tips('请输入正确的流水号', $(this).find('.serial-num'), { tips: [3, '#faab20'] });
          is_error = 1;
          all_is_ok = 0;
          return false;
        }

        if(!amount.length) {
          layer.tips('请正确填写金额', $(this).find('.amount'), { tips: [3, '#faab20'] });
          is_error = 1;
          all_is_ok = 0;
          return false;
        }
        serial_num_with_store_code = gndcode + serial_num;
        if(serial_nums.indexOf(serial_num_with_store_code) >= 0) {
          layer.tips('流水号重复', $(this).find('.serial-num'), { tips: [3, '#faab20'] });
          is_error = 1;
          all_is_ok = 0;
          return false;
        }
        if(store_and_datetimes.indexOf(store_and_datetime) >= 0) {
          layer.tips('请勿重复积分', $(this).find('.store-name'), { tips: [3, '#faab20'] });
          is_error = 1;
          all_is_ok = 0;
          return false;
        }

        serial_nums.push(serial_num_with_store_code);
        store_and_datetimes.push(store_and_datetime);
        /*===updatecynthia0926 gndgid start===*/
        data = {
          card_number: card_number,
          serial_num: serial_num,
          store_name: store_name,
          store_code: gndcode,
            gndgid:gndgid,
          real_amt: amount,
          score: parseInt(amount),
          datetime: datetime,
          wrapper_class: wrapper_class
        };
          /*===updatecynthia0926 start===*/
        datas.push(data);
      }
    });

    if (all_is_ok) {
      $(".submit-btn").attr("disabled", "disabled");
      /*===1016 start===*/
        window.localStorage.setItem("scoreInputRecords", JSON.stringify(datas));
        /*===cynthia 0913保存图片到缓存 start===*/
        saveimgstore();
        /*===cynthia 0913保存图片到缓存 end===*/
      window.TKH.calcMallScoreExWeb2(0, '消费积分');
    }
  });

  $(".skip-btn").on("click", function() {
      layer.open({
        type:1,
        title: "温馨提示",
        area:"500px",
        content:$('#tishiarea1')
      });
  });

});
</script>

<script src="assets/javascripts/side.js?timestamp=1517404944"></script>
<script type="text/javascript">
  window.onload = function() {
    $('#jiaZai').hide();
    $('#main').show();
  }
  window.onresize = function() {
    console.log("width = " + window.innerWidth + ";height=" + window.innerHeight);
    $("#main").css({
      "background": "url('assets/images/bg-blur.jpg')",
      "filter": "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale')",
      "-moz-background-size": "100% 100%",
      "background-size": "100% 100%",
      "-webkit-animation": "fadeIn .6s backwards",
      "display": "block"
    });
  }

</script>
</body>
</html>
